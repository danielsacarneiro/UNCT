drop table IF EXISTS demanda_SEI;
-- Create temporary table demanda_SEI (SEI VARCHAR(25));
Create table demanda_SEI (SEI VARCHAR(25));
insert into demanda_SEI (SEI)
values 
('1500000027000417202021'),
('1500000011001274202043'),
('1500000176000045201995'),
('1500000180000246202067'),
('1500000200001793201941'),
('1500000165000243202011'),
('1500000011000668202084'),
('1500000176000069201944'),
('1500000024000384202049'),
('1500000027000416202086'),
('1500000165000066202073'),
('1500000165000068202062'),
('1500000025000906202001'),
('1500000189000070202063'),
('1500000024000386202038'),
('1500000027000546202019'),
('1500000184000879201900'),
('1500000172000066202084'),
('1500000025000503202053'),
('1500000163000163201942');

SELECT SEI FROM demanda_SEI
where not exists 
(
select DEMANDA_TRAM.DTM_PRT,DEMANDA_TRAM.dem_ex,DEMANDA_TRAM.dem_CD from DEMANDA_TRAM 
LEFT JOIN DEMANDA 
ON DEMANDA_TRAM.dem_ex = DEMANDA.dem_ex 
AND DEMANDA_TRAM.dem_cd = DEMANDA.dem_cd 

LEFT JOIN ( SELECT MAX(dtm_sq) AS dtm_sq,dem_cd,dem_ex FROM demanda_tram GROUP BY dem_cd,dem_ex) TABELA_MAX 
ON DEMANDA.dem_ex = TABELA_MAX.dem_ex 
AND DEMANDA.dem_cd = TABELA_MAX.dem_cd 
LEFT JOIN DEMANDA_TRAM TABELA_MAX_TRAM
ON TABELA_MAX_TRAM.dem_ex = TABELA_MAX.dem_ex 
AND TABELA_MAX_TRAM.dem_cd = TABELA_MAX.dem_cd 
AND TABELA_MAX_TRAM.dtm_sq = TABELA_MAX.dtm_sq 

WHERE DEMANDA_TRAM.DTM_PRT IS NOT NULL
-- and (demanda.dem_tipo in (1,2, 9)) -- demanda contrato apenas (parecer e PAAP incluso)
AND (TABELA_MAX_TRAM.dtm_cd_setor_destino in (3) OR demanda.dem_tipo = 2) -- destino 3 eh atja, demanda tipo 2 eh PAAP
and demanda.dem_situacao <> 2
and demanda.in_desativado = 'N'

and SEI =  DEMANDA_TRAM.DTM_PRT
GROUP BY DEMANDA_TRAM.DTM_PRT
)

