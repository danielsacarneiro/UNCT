drop table IF EXISTS demanda_SEI;
-- Create temporary table demanda_SEI (SEI VARCHAR(25));
Create table demanda_SEI (SEI VARCHAR(25));
insert into demanda_SEI (SEI)
values 
('1500000195000042202067'),
('1500000180000355202084'),
('1500000195000007202048'),
('1500000180000352202041'),
('1500000193000375202014'),
('1500000011001372202081'),
('1500000267000118202063'),
('1500000195000028202063'),
('1500000194000201201908'),
('1500000025002277202045'),
('1500000165000345202037'),
('1500000180000246202067'),
('1500000195000062202038'),
('1500000195000043201978'),
('1500000180000349202027'),
('1500000180000356202029'),
('1500000180000392202092'),
('1500000025000298202026'),
('1500000193000655201981'),
('0030409418000020201939'),
('1500000192000235202048'),
('1500000279000001202041'),
('1500000025001178202046'),
('1500000193000509201955'),
('1500000261000203202081'),
('1500000195000063202082'),
('1500000165000620201989'),
('1500000200001793201941'),
('1500000193000466202041'),
('1500000025002087202028'),
('1500000209000010202065'),
('1500000161000357202000'),
('1500000025000963202081'),
('1500000161000292202094'),
('1500000122000165202051'),
('1500000298000023202082'),
('1500000165000307202084'),
('1500000195000002202015'),
('1500000180000326202012'),
('1500000025001179202091'),
('1500000188000116202054'),
('1500000191000104202071'),
('1500000193000298202094'),
('1500000209000031202081'),
('1500000247000711201912'),
('1500000011001274202043'),
('1500000193000262202019'),
('1500000001002730202091'),
('1500000193000570201901'),
('1500000195000025201996'),
('1500000161000102201903'),
('1500000195000010202061'),
('1500000261000305202005'),
('1500000027001323202079'),
('1500000209000004202016'),
('1500000011001418202061'),
('1500000193000358202079'),
('1500000261000293202019'),
('1500000025000370202015'),
('1500000027000810202014'),
('1500000193000072202093'),
('1500000193000122202032'),
('1500000195000003202060'),
('1500000184000879201900'),
('0001200159000279202012'),
('1500000195000044202056'),
('1500000195000039202043'),
('1500000195000041202012'),
('1500000027000416202086'),
('1500000165000662201910'),
('1500000228000026202040'),
('1500000003001292201991');

call consultarDemandaSEIEcontiATJA();
call consultarDemandaSEIEcontiUNCT();

/** PROCEDURE CONSULTA AOS SEIS ATJA E UNCT*/
DELIMITER $$
DROP PROCEDURE IF EXISTS consultarDemandaSEIEcontiATJA $$
-- CREATE PROCEDURE importarContratada(IN cdPessoa INT)
CREATE PROCEDURE consultarDemandaSEIEcontiATJA()
BEGIN

SELECT SEI FROM demanda_SEI
where not exists 
(
select DEMANDA_TRAM.DTM_PRT,DEMANDA_TRAM.dem_ex,DEMANDA_TRAM.dem_CD from DEMANDA_TRAM 
LEFT JOIN DEMANDA 
ON DEMANDA_TRAM.dem_ex = DEMANDA.dem_ex 
AND DEMANDA_TRAM.dem_cd = DEMANDA.dem_cd 

LEFT JOIN ( SELECT MAX(dtm_sq) AS dtm_sq,dem_cd,dem_ex FROM demanda_tram GROUP BY dem_cd,dem_ex) TABELA_MAX 
ON DEMANDA.dem_ex = TABELA_MAX.dem_ex 
AND DEMANDA.dem_cd = TABELA_MAX.dem_cd 
LEFT JOIN DEMANDA_TRAM TABELA_MAX_TRAM
ON TABELA_MAX_TRAM.dem_ex = TABELA_MAX.dem_ex 
AND TABELA_MAX_TRAM.dem_cd = TABELA_MAX.dem_cd 
AND TABELA_MAX_TRAM.dtm_sq = TABELA_MAX.dtm_sq 

WHERE DEMANDA_TRAM.DTM_PRT IS NOT NULL
-- and (demanda.dem_tipo in (1,2, 9)) -- demanda contrato apenas (parecer e PAAP incluso)
AND (TABELA_MAX_TRAM.dtm_cd_setor_destino in (3) OR demanda.dem_tipo = 2) -- destino 3 eh atja, demanda tipo 2 eh PAAP
and demanda.dem_situacao <> 2
and demanda.in_desativado = 'N'

and SEI =  DEMANDA_TRAM.DTM_PRT
GROUP BY DEMANDA_TRAM.DTM_PRT
);
  
END $$
DELIMITER ;

DELIMITER $$
DROP PROCEDURE IF EXISTS consultarDemandaSEIEcontiUNCT $$
-- CREATE PROCEDURE importarContratada(IN cdPessoa INT)
CREATE PROCEDURE consultarDemandaSEIEcontiUNCT()
BEGIN

SELECT SEI FROM demanda_SEI
where not exists 
(
select DEMANDA_TRAM.DTM_PRT,DEMANDA_TRAM.dem_ex,DEMANDA_TRAM.dem_CD from DEMANDA_TRAM 
LEFT JOIN DEMANDA 
ON DEMANDA_TRAM.dem_ex = DEMANDA.dem_ex 
AND DEMANDA_TRAM.dem_cd = DEMANDA.dem_cd 

LEFT JOIN ( SELECT MAX(dtm_sq) AS dtm_sq,dem_cd,dem_ex FROM demanda_tram GROUP BY dem_cd,dem_ex) TABELA_MAX 
ON DEMANDA.dem_ex = TABELA_MAX.dem_ex 
AND DEMANDA.dem_cd = TABELA_MAX.dem_cd 
LEFT JOIN DEMANDA_TRAM TABELA_MAX_TRAM
ON TABELA_MAX_TRAM.dem_ex = TABELA_MAX.dem_ex 
AND TABELA_MAX_TRAM.dem_cd = TABELA_MAX.dem_cd 
AND TABELA_MAX_TRAM.dtm_sq = TABELA_MAX.dtm_sq 

WHERE DEMANDA_TRAM.DTM_PRT IS NOT NULL
-- and (demanda.dem_tipo in (1,2, 9)) -- demanda contrato apenas (parecer e PAAP incluso)
AND (TABELA_MAX_TRAM.dtm_cd_setor_destino in (2))
and demanda.dem_situacao <> 2
and demanda.in_desativado = 'N'

and SEI =  DEMANDA_TRAM.DTM_PRT
GROUP BY DEMANDA_TRAM.DTM_PRT
);
  
END $$
DELIMITER ;

/** PROCEDURE CONSULTA */

