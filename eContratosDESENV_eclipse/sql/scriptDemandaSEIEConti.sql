drop table IF EXISTS demanda_SEI;
Create temporary table demanda_SEI (SEI VARCHAR(25));
insert into demanda_SEI (SEI)
values 
('1500000025001296201911'),
('1500000025001200201914'),
('1500000011001519201907'),
('1500000193000192201957'),
('1500000195000031201943'),
('1500000011002618201906'),
('1500000075000156201930'),
('1500000011001521201978'),
('1500000066000872201926'),
('1500000122000709201941'),
('1500000075000104201963'),
('1500000011001513201921'),
('1500000193000365201937'),
('1500000066000915201973'),
('1500000025001497201918'),
('1500000163000163201942'),
('1500000025000372201971'),
('1500000122000705201963');

SELECT SEI FROM demanda_SEI
where not exists 
(
select DEMANDA_TRAM.DTM_PRT,DEMANDA_TRAM.dem_ex,DEMANDA_TRAM.dem_CD from DEMANDA_TRAM 
LEFT JOIN DEMANDA 
ON DEMANDA_TRAM.dem_ex = DEMANDA.dem_ex 
AND DEMANDA_TRAM.dem_cd = DEMANDA.dem_cd 

LEFT JOIN ( SELECT MAX(dtm_sq) AS dtm_sq,dem_cd,dem_ex FROM demanda_tram GROUP BY dem_cd,dem_ex) TABELA_MAX 
ON DEMANDA.dem_ex = TABELA_MAX.dem_ex 
AND DEMANDA.dem_cd = TABELA_MAX.dem_cd 
LEFT JOIN DEMANDA_TRAM TABELA_MAX_TRAM
ON TABELA_MAX_TRAM.dem_ex = TABELA_MAX.dem_ex 
AND TABELA_MAX_TRAM.dem_cd = TABELA_MAX.dem_cd 
AND TABELA_MAX_TRAM.dtm_sq = TABELA_MAX.dtm_sq 

WHERE DEMANDA_TRAM.DTM_PRT IS NOT NULL
AND TABELA_MAX_TRAM.dtm_cd_setor_destino in (3,99) -- atja OU EXTERNO
and demanda.dem_situacao <> 2
and demanda.in_desativado = 'N'

and SEI =  DEMANDA_TRAM.DTM_PRT
GROUP BY DEMANDA_TRAM.DTM_PRT
)

